<div class="container mt-4">
  <!-- TÍTULO -->
  <div class="card shadow-sm mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
      <h4 class="fw-bold text-primary mb-0">
        <i class="fas fa-prescription me-2"></i> Nueva Receta Médica
      </h4>
      <button class="btn btn-secondary btn-sm" (click)="volver()">
        <i class="fas fa-arrow-left me-1"></i> Volver
      </button>
    </div>
  </div>

  <!-- FORMULARIO DE RECETA -->
  <div class="card shadow-sm">
    <div class="card-body">
      <form #formReceta="ngForm" class="row g-3 align-items-end" novalidate>
        <!-- Consulta médica -->
        <div class="col-md-6">
          <label class="form-label small fw-semibold">Consulta Médica <span class="text-danger">*</span></label>
          <select
            class="form-select form-select-sm"
            [(ngModel)]="nuevaReceta.id_consulta"
            name="consulta"
            (change)="actualizarPaciente()"
          >
            <option value="">Seleccione</option>
            <option *ngFor="let c of consultasDisponibles" [value]="c.id">
               Consulta #{{ c.id }} - {{ formatearFecha(c.fecha) }} - {{ c.paciente }}
            </option>
          </select>
        </div>

        <!-- Paciente -->
        <div class="col-md-6">
          <label class="form-label small fw-semibold">Paciente</label>
          <input
            type="text"
            class="form-control form-control-sm bg-light"
            [(ngModel)]="nuevaReceta.paciente"
            name="paciente"
            readonly
          />
        </div>

        <!-- Diagnóstico -->
        <div class="col-md-12">
          <label class="form-label small fw-semibold">Diagnóstico <span class="text-danger">*</span></label>
          <textarea
            class="form-control form-control-sm"
            rows="2"
            [(ngModel)]="nuevaReceta.diagnostico"
            name="diagnostico"
            placeholder="Ingrese el diagnóstico..."
          ></textarea>
        </div>

        <!-- Medicamentos -->
        <div class="col-12 mt-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label small fw-semibold mb-0">Medicamentos <span class="text-danger">*</span></label>
            <button type="button" class="btn btn-sm btn-outline-primary" (click)="agregarMedicamento()">
              <i class="fas fa-plus me-1"></i> Agregar
            </button>
          </div>

          <div *ngFor="let med of nuevaReceta.detalles; let i = index" class="card border-light mb-3">
            <div class="card-header bg-light fw-semibold py-2">
              Medicamento {{ i + 1 }}
              <button
                type="button"
                class="btn btn-sm btn-outline-danger float-end"
                (click)="eliminarMedicamento(i)"
                title="Eliminar"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>

            <div class="card-body row g-2 align-items-end">
              <div class="col-md-4">
                <label class="form-label small text-muted">Nombre</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  [(ngModel)]="med.nombre_medicamento"
                  name="nombre{{ i }}"
                  placeholder="Ej: Paracetamol 500mg"
                />
              </div>

              <div class="col-md-2">
                <label class="form-label small text-muted">Dosis</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  [(ngModel)]="med.dosis"
                  name="dosis{{ i }}"
                  placeholder="1 tableta"
                />
              </div>

              <div class="col-md-3">
                <label class="form-label small text-muted">Frecuencia</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  [(ngModel)]="med.frecuencia"
                  name="frecuencia{{ i }}"
                  placeholder="Cada 8 horas"
                />
              </div>

              <div class="col-md-3">
                <label class="form-label small text-muted">Duración</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  [(ngModel)]="med.duracion"
                  name="duracion{{ i }}"
                  placeholder="7 días"
                />
              </div>

              <div class="col-12">
                <label class="form-label small text-muted">Indicaciones</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  [(ngModel)]="med.indicaciones"
                  name="indicaciones{{ i }}"
                  placeholder="Tomar después de las comidas"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Observaciones -->
        <div class="col-12">
          <label class="form-label small fw-semibold">Observaciones</label>
          <textarea
            class="form-control form-control-sm"
            rows="3"
            [(ngModel)]="nuevaReceta.observaciones"
            name="observaciones"
            placeholder="Escriba observaciones adicionales..."
          ></textarea>
        </div>

        <!-- Firma digital -->
        <div class="col-md-6">
          <label class="form-label small fw-semibold">Firma Digital <span class="text-danger">*</span></label>
          <input type="file" class="form-control form-control-sm" (change)="onFileSelected($event)" />
        </div>
      </form>
    </div>
  </div>

  <!-- BOTONES -->
  <div class="d-flex justify-content-end mt-4 gap-2">
    <button class="btn btn-secondary btn-sm" (click)="volver()">
      <i class="fas fa-arrow-left me-1"></i> Cancelar
    </button>
    <button class="btn btn-success btn-sm" (click)="guardarReceta()">
      <i class="fas fa-save me-1"></i> Guardar Receta
    </button>
  </div>
</div>