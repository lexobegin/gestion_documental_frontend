<div class="container mt-4">

  <!-- ENCABEZADO -->
  <div class="card shadow-sm mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
      <h4 class="fw-bold text-primary mb-0">
        <i class="fas fa-prescription-bottle-alt me-2"></i>
        Gestión de Recetas Médicas
      </h4>
      <button class="btn btn-primary btn-lg shadow-sm" [routerLink]="['/recetas/crear']">
      <i class="fas fa-plus me-1"></i> Nueva Receta
      </button>
    </div>
  </div>

  <!-- CONSULTAS DISPONIBLES -->
  <div class="card shadow-sm mb-4">
    <div class="card-header text-bg-primary">
      <h6 class="mb-0 fw-bold">
        <i class="fas fa-calendar-check me-2"></i>
        Consultas Médicas Disponibles ({{ consultasFiltradas.length }})
      </h6>
    </div>

    <!-- BUSCADOR Y FILTROS -->
<div class="card-body border-bottom">
  <form class="row gx-2 gy-2 align-items-center">
    <div class="col-md-4 col-lg-4 flex-grow-1">
      <div class="input-group w-100">
        <span class="input-group-text bg-white border-end-0">
          <i class="fas fa-search text-muted"></i>
        </span>
        <input 
          type="text" 
          class="form-control border-start-0" 
          placeholder="Buscar por paciente o médico..." 
          [(ngModel)]="busqueda"
          name="busqueda"
        />
      </div>
    </div>

    <div class="col-md-3 col-lg-3">
      <select class="form-select w-100" [(ngModel)]="estadoFiltro" name="estadoFiltro">
        <option value="todos">Todos los estados</option>
        <option value="Confirmada">Confirmada</option>
        <option value="Realizada">Realizada</option>
      </select>
    </div>

    <div class="col-md-3 col-lg-3">
      <input 
        type="date" 
        class="form-control w-100" 
        [(ngModel)]="fechaFiltro"
        name="fechaFiltro"
      />
    </div>

    <div class="col-md-2 col-lg-2 d-grid">
      <button class="btn btn-outline-secondary w-100" (click)="limpiarFiltros()" type="button">
        <i class="fas fa-eraser me-1"></i> Limpiar
      </button>
    </div>
  </form>

  <!-- Botones de exportación -->
  <div class="d-flex flex-wrap justify-content-start gap-2 mt-3">
    <button class="btn btn-danger btn-sm" (click)="exportarConsultasPDF()">
      <i class="fas fa-file-pdf me-1"></i> PDF
    </button>
    <button class="btn btn-success btn-sm" (click)="exportarConsultasExcel()">
      <i class="fas fa-file-excel me-1"></i> Excel
    </button>
    <button class="btn btn-warning btn-sm text-white" (click)="exportarConsultasHTML()">
      <i class="fas fa-file-code me-1"></i> HTML
    </button>
  </div>
</div>

    <!-- TABLA DE CONSULTAS -->
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Paciente</th>
              <th>Médico</th>
              <th>Especialidad</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Estado</th>
              <th>Motivo</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let c of consultasFiltradas">
              <td><strong>{{ c.id }}</strong></td>

              <td>
                <div class="d-flex align-items-center">
                  <div class="bg-primary-subtle text-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                    <i class="fas fa-user"></i>
                  </div>
                  <strong>{{ c.paciente }}</strong>
                </div>
              </td>

              <td>{{ c.medico }}</td>

              <td>
                <span class="badge text-bg-info">{{ c.especialidad }}</span>
              </td>

              <td>
                <i class="fas fa-calendar text-muted me-1"></i>
                {{ formatearFecha(c.fecha) }}
              </td>

              <td class="text-primary fw-bold">
                <i class="fas fa-clock me-1"></i> {{ c.hora }}
              </td>

              <td>
                <span class="badge px-3 py-2"
                      [ngClass]="{
                        'text-bg-primary': c.estado === 'Confirmada',
                        'text-bg-success': c.estado === 'Realizada'
                      }">
                  <i class="fas fa-check-circle me-1"></i>
                  {{ c.estado }}
                </span>
              </td>

              <td>{{ c.motivo }}</td>

              <td class="text-center">
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-info" (click)="verDetalleConsulta(c)" title="Ver Detalle">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn btn-outline-success" (click)="crearRecetaDesdeConsulta(c.id)" title="Crear Receta">
                    <i class="fas fa-plus"></i>
                  </button>
                  <button class="btn btn-outline-danger" (click)="eliminarConsulta(c.id)" title="Eliminar">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </td>
            </tr>

            <tr *ngIf="consultasFiltradas.length === 0">
              <td colspan="9" class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                No se encontraron consultas con los filtros aplicados
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- RECETAS REGISTRADAS -->
  <div class="card shadow-sm">
    <div class="card-header text-bg-success">
      <h6 class="mb-0 fw-bold">
        <i class="fas fa-prescription me-2"></i>
        Recetas Médicas Registradas ({{ recetasFiltradas.length }})
      </h6>
    </div>

    <!-- FILTROS AVANZADOS PARA RECETAS -->
    <div class="card-body border-bottom">
      <div class="row g-3 align-items-end">

        <!-- Buscador -->
        <div class="col-md-3">
          <label class="form-label text-muted small fw-semibold">Buscar</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search text-muted"></i></span>
            <input
              type="text"
              class="form-control"
              placeholder="Buscar por paciente o médico..."
              [(ngModel)]="busqueda"
            />
          </div>
        </div>

        <!-- Médico -->
        <div class="col-md-2">
          <label class="form-label text-muted small fw-semibold">Médico</label>
          <select class="form-select" [(ngModel)]="filtroMedico">
            <option value="todos">Todos</option>
            <option *ngFor="let medico of medicosUnicos" [value]="medico">
              {{ medico }}
            </option>
          </select>
        </div>

        <!-- Paciente -->
        <div class="col-md-2">
          <label class="form-label text-muted small fw-semibold">Paciente</label>
          <select class="form-select" [(ngModel)]="filtroPaciente">
            <option value="todos">Todos</option>
            <option *ngFor="let paciente of pacientesUnicos" [value]="paciente">
              {{ paciente }}
            </option>
          </select>
        </div>

        <!-- Fecha Desde -->
        <div class="col-md-2">
          <label class="form-label text-muted small fw-semibold">Desde</label>
          <input type="date" class="form-control" [(ngModel)]="filtroDesde" />
        </div>

        <!-- Fecha Hasta -->
        <div class="col-md-2">
          <label class="form-label text-muted small fw-semibold">Hasta</label>
          <input type="date" class="form-control" [(ngModel)]="filtroHasta" />
        </div>

        <!-- Botón Limpiar -->
        <div class="col-md-1 d-grid">
          <button class="btn btn-outline-secondary btn-sm" (click)="limpiarFiltros()">
            <i class="fas fa-eraser"></i>
          </button>
        </div>
      </div>

      <!-- Botones de exportación -->
      <div class="d-flex gap-2 flex-wrap mt-3">
        <button class="btn btn-danger btn-sm" (click)="exportarRecetasPDF()">
          <i class="fas fa-file-pdf me-1"></i> PDF
        </button>
        <button class="btn btn-success btn-sm" (click)="exportarRecetasExcel()">
          <i class="fas fa-file-excel me-1"></i> Excel
        </button>
        <button class="btn btn-warning btn-sm text-white" (click)="exportarRecetasHTML()">
          <i class="fas fa-file-code me-1"></i> HTML
        </button>
      </div>
    </div>

    <!-- TABLA DE RECETAS -->
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Paciente</th>
              <th>Médico</th>
              <th>Diagnóstico</th>
              <th>Fecha</th>
              <th>Estado</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let r of recetasFiltradas">
              <td><strong>{{ r.id }}</strong></td>

              <td>
                <div class="d-flex align-items-center">
                  <div class="bg-success-subtle text-success rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                    <i class="fas fa-user"></i>
                  </div>
                  <strong>{{ r.paciente }}</strong>
                </div>
              </td>

              <td>{{ r.medico }}</td>

              <td>
                <span class="badge text-bg-warning text-dark">
                  {{ r.diagnostico }}
                </span>
              </td>

              <td>
                <i class="fas fa-calendar text-muted me-1"></i>
                {{ formatearFecha(r.fecha_receta) }}
              </td>

              <td>
                <span class="badge text-bg-success px-3 py-2">
                  <i class="fas fa-check-circle me-1"></i>
                  Activa
                </span>
              </td>

              <td class="text-center">
                <div class="btn-group btn-group-sm">
                  <button
                    class="btn btn-outline-info"
                    (click)="verReceta(r)"
                    title="Ver Detalle"
                  >
                    <i class="fas fa-eye"></i>
                  </button>
                  <button
                    class="btn btn-outline-success"
                    (click)="editarReceta(r.id)"
                    title="Editar"
                  >
                    <i class="fas fa-pen"></i>
                  </button>
                  <button
                    class="btn btn-outline-danger"
                    (click)="eliminarReceta(r.id)"
                    title="Eliminar"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>

            <tr *ngIf="recetasFiltradas.length === 0">
              <td colspan="7" class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                No se encontraron recetas con los filtros aplicados
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<!-- MODAL DETALLE CONSULTA -->
<div 
  class="modal fade" 
  [class.show]="mostrarModalConsulta" 
  [style.display]="mostrarModalConsulta ? 'block' : 'none'"
  tabindex="-1"
  *ngIf="mostrarModalConsulta"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      
      <!-- Header -->
      <div class="modal-header text-bg-primary">
        <h5 class="modal-title">
          <i class="fas fa-clipboard-list me-2"></i>
          Detalle de Consulta #{{ consultaSeleccionada?.id }}
        </h5>
        <button 
          type="button" 
          class="btn-close btn-close-white" 
          (click)="cerrarModalConsulta()"
        ></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <div class="row g-3" *ngIf="consultaSeleccionada">
          <div class="col-md-6">
            <label class="text-muted small">Paciente</label>
            <p class="fw-semibold mb-0">{{ consultaSeleccionada.paciente }}</p>
          </div>

          <div class="col-md-6">
            <label class="text-muted small">Médico</label>
            <p class="fw-semibold mb-0">{{ consultaSeleccionada.medico }}</p>
          </div>

          <div class="col-md-6">
            <label class="text-muted small">Especialidad</label>
            <p class="mb-0">
              <span class="badge text-bg-info">
                {{ consultaSeleccionada.especialidad }}
              </span>
            </p>
          </div>

          <div class="col-md-6">
            <label class="text-muted small">Estado</label>
            <p class="mb-0">
              <span 
                class="badge"
                [ngClass]="{
                  'text-bg-success': consultaSeleccionada.estado === 'Confirmada',
                  'text-bg-info': consultaSeleccionada.estado === 'Realizada'
                }"
              >
                {{ consultaSeleccionada.estado }}
              </span>
            </p>
          </div>

          <div class="col-md-6">
            <label class="text-muted small">Fecha</label>
            <p class="fw-semibold mb-0">{{ formatearFecha(consultaSeleccionada.fecha) }}</p>
          </div>

          <div class="col-md-6">
            <label class="text-muted small">Hora</label>
            <p class="fw-semibold text-primary mb-0">{{ consultaSeleccionada.hora }}</p>
          </div>

          <div class="col-12">
            <label class="text-muted small">Motivo de Consulta</label>
            <p class="mb-0">{{ consultaSeleccionada.motivo }}</p>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer bg-light border-top">
        <button class="btn btn-secondary" (click)="cerrarModalConsulta()">
          <i class="fas fa-times me-1"></i> Cerrar
        </button>
        <button class="btn btn-success" (click)="crearRecetaDesdeConsulta(consultaSeleccionada.id)">
          <i class="fas fa-plus me-1"></i> Crear Receta
        </button>
      </div>
    </div>
  </div>
</div>
<!-- MODAL DETALLE RECETA -->
<div 
  class="modal fade" 
  [class.show]="mostrarModalDetalle" 
  [style.display]="mostrarModalDetalle ? 'block' : 'none'"
  tabindex="-1"
  *ngIf="mostrarModalDetalle"
>
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content border-0 shadow-lg">

      <!-- Header -->
      <div class="modal-header text-bg-success">
        <h5 class="modal-title">
          <i class="fas fa-prescription me-2"></i>
          Detalle de Receta Médica #{{ recetaSeleccionada?.id }}
        </h5>
        <button 
          type="button" 
          class="btn-close btn-close-white" 
          (click)="cerrarModalDetalle()"
        ></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <div *ngIf="recetaSeleccionada">
          
          <!-- Información General -->
          <div class="card mb-3 border-0 shadow-sm">
            <div class="card-header bg-light fw-semibold">
              Información General
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="text-muted small">Paciente</label>
                  <p class="fw-semibold mb-0">{{ recetaSeleccionada.paciente }}</p>
                </div>

                <div class="col-md-4">
                  <label class="text-muted small">Médico</label>
                  <p class="fw-semibold mb-0">{{ recetaSeleccionada.medico }}</p>
                </div>

                <div class="col-md-4">
                  <label class="text-muted small">Fecha</label>
                  <p class="fw-semibold mb-0">{{ formatearFecha(recetaSeleccionada.fecha_receta) }}</p>
                </div>

                <div class="col-12">
                  <label class="text-muted small">Diagnóstico</label>
                  <p class="mb-0">
                    <span class="badge text-bg-warning text-dark fs-6">
                      {{ recetaSeleccionada.diagnostico }}
                    </span>
                  </p>
                </div>

                <div class="col-12">
                  <label class="text-muted small">Observaciones</label>
                  <p class="mb-0">{{ recetaSeleccionada.observaciones }}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Medicamentos -->
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-light fw-semibold">
              <i class="fas fa-pills me-2"></i> Medicamentos Recetados 
              ({{ recetaSeleccionada.detalles?.length || 0 }})
            </div>

            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Medicamento</th>
                      <th>Dosis</th>
                      <th>Frecuencia</th>
                      <th>Duración</th>
                      <th>Indicaciones</th>
                    </tr>
                  </thead>

                  <tbody>
                    <tr *ngFor="let detalle of recetaSeleccionada.detalles">
                      <td>
                        <strong class="text-primary">
                          <i class="fas fa-capsules me-2"></i>
                          {{ detalle.nombre_medicamento }}
                        </strong>
                      </td>
                      <td>{{ detalle.dosis }}</td>
                      <td>
                        <span class="badge text-bg-info">
                          {{ detalle.frecuencia }}
                        </span>
                      </td>
                      <td>
                        <span class="badge text-bg-success">
                          {{ detalle.duracion }}
                        </span>
                      </td>
                      <td>{{ detalle.indicaciones }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer bg-light border-top">
        <button class="btn btn-secondary" (click)="cerrarModalDetalle()">
          <i class="fas fa-times me-1"></i> Cerrar
        </button>
        <button class="btn btn-primary" (click)="imprimirReceta()">
          <i class="fas fa-print me-1"></i> Imprimir Receta
        </button>
      </div>
    </div>
  </div>
</div>

<!-- BACKDROP para ambos modales -->
<div 
  class="modal-backdrop fade show"
  *ngIf="mostrarModalDetalle || mostrarModalConsulta"
  (click)="cerrarModalDetalle(); cerrarModalConsulta()"
></div>
<!-- === BACKDROP GLOBAL DE MODALES === -->
<div
  class="modal-backdrop fade show"
  *ngIf="mostrarModalDetalle || mostrarModalConsulta"
  (click)="cerrarModalDetalle(); cerrarModalConsulta()"
></div>

<!-- === TRANSICIÓN / EFECTO DE FONDO === -->
<style>
  /* Mantiene efecto de desvanecimiento Bootstrap, sin estilos extra */
  .modal-backdrop.show {
    opacity: 0.5; /* efecto de oscurecimiento del fondo */
  }
</style>
