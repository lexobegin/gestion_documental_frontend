<div class="container mt-4">

  <!-- ENCABEZADO -->
  <div class="card shadow-sm mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
      <h4 class="fw-bold text-primary mb-0">
        <i class="fas fa-prescription-bottle-alt me-2"></i>
        Gestión de Recetas Médicas
      </h4>

      <button class="btn btn-primary btn-lg shadow-sm" [routerLink]="['/recetas/crear']">
        <i class="fas fa-plus me-1"></i> Nueva Receta
      </button>
    </div>
  </div>

  <!-- RECETAS REGISTRADAS -->
  <div class="card shadow-sm">

    <div class="card-header text-bg-success">
      <h6 class="mb-0 fw-bold">
        <i class="fas fa-prescription me-2"></i>
        Recetas Médicas Registradas ({{ recetasFiltradas.length }})
      </h6>
    </div>

    <!-- FILTROS -->
    <div class="card-body border-bottom">
      <div class="row g-3 align-items-end">

        <!-- Buscador -->
        <div class="col-md-3">
          <label class="form-label text-muted small fw-semibold">Buscar</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search text-muted"></i></span>
            <input type="text" class="form-control" placeholder="Buscar por paciente o médico..." [(ngModel)]="busqueda">
          </div>
        </div>

        <!-- Médico -->
        <div class="col-md-2">
          <label class="form-label text-muted small fw-semibold">Médico</label>
          <select class="form-select" [(ngModel)]="filtroMedico">
            <option value="todos">Todos</option>
            <option *ngFor="let medico of medicosUnicos" [value]="medico">{{ medico }}</option>
          </select>
        </div>

        <!-- Paciente -->
        <div class="col-md-2">
          <label class="form-label text-muted small fw-semibold">Paciente</label>
          <select class="form-select" [(ngModel)]="filtroPaciente">
            <option value="todos">Todos</option>
            <option *ngFor="let paciente of pacientesUnicos" [value]="paciente">{{ paciente }}</option>
          </select>
        </div>

        <!-- Fecha Desde -->
        <div class="col-md-2">
          <label class="form-label text-muted small fw-semibold">Desde</label>
          <input type="date" class="form-control" [(ngModel)]="filtroDesde">
        </div>

        <!-- Fecha Hasta -->
        <div class="col-md-2">
          <label class="form-label text-muted small fw-semibold">Hasta</label>
          <input type="date" class="form-control" [(ngModel)]="filtroHasta">
        </div>

        <!-- Botón Limpiar -->
        <div class="col-md-1 d-grid">
          <button class="btn btn-outline-secondary btn-sm" (click)="limpiarFiltros()">
            <i class="fas fa-eraser"></i>
          </button>
        </div>
      </div>

      <!-- Botones de exportación -->
      <div class="d-flex gap-2 flex-wrap mt-3">
        <button class="btn btn-danger btn-sm" (click)="exportarRecetasPDF()">
          <i class="fas fa-file-pdf me-1"></i> PDF
        </button>
        <button class="btn btn-success btn-sm" (click)="exportarRecetasExcel()">
          <i class="fas fa-file-excel me-1"></i> Excel
        </button>
        <button class="btn btn-warning btn-sm text-white" (click)="exportarRecetasHTML()">
          <i class="fas fa-file-code me-1"></i> HTML
        </button>
      </div>
    </div>

    <!-- TABLA DE RECETAS -->
    <div class="card-body p-0">
      <div class="table-responsive" style="max-height: 480px; overflow-y: auto;">

        <table class="table table-hover align-middle mb-0">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Paciente</th>
              <th>Médico</th>
              <th>Fecha</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>

          <tbody>

            <tr *ngFor="let r of recetasFiltradas">
              <td><strong>{{ r.id }}</strong></td>

              <td>
                <div class="d-flex align-items-center">
                  <div class="bg-success-subtle text-success rounded-circle d-flex align-items-center justify-content-center me-2"
                       style="width: 32px; height: 32px;">
                    <i class="fas fa-user"></i>
                  </div>
                  <strong>{{ r.paciente_nombre }}</strong>
                </div>
              </td>

              <td>{{ r.medico_nombre }}</td>

              <td>
                <i class="fas fa-calendar text-muted me-1"></i>
                {{ formatearFecha(r.fecha_receta) }}
              </td>

              <td class="text-center">
                <div class="btn-group btn-group-sm">

                  <button class="btn btn-outline-info" (click)="verReceta(r)" title="Ver Detalle">
                    <i class="fas fa-eye"></i>
                  </button>

                  <button class="btn btn-outline-success" (click)="editarReceta(r.id)" title="Editar">
                    <i class="fas fa-pen"></i>
                  </button>

                  <button class="btn btn-outline-danger" (click)="eliminarReceta(r.id)" title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </button>

                </div>
              </td>
            </tr>

            <tr *ngIf="recetasFiltradas.length === 0">
              <td colspan="5" class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                No se encontraron recetas con los filtros aplicados
              </td>
            </tr>

          </tbody>
        </table>

      </div>
    </div>
  </div>

  <!-- MODAL DETALLE DE RECETA -->
  <div class="modal fade" [class.show]="mostrarModalDetalle" [style.display]="mostrarModalDetalle ? 'block' : 'none'" tabindex="-1"
       *ngIf="mostrarModalDetalle">

    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg">

        <!-- Header -->
        <div class="modal-header text-bg-success">
          <h5 class="modal-title">
            <i class="fas fa-prescription me-2"></i>
            Detalle de Receta #{{ recetaSeleccionada?.id }}
          </h5>

          <button type="button" class="btn-close btn-close-white" (click)="cerrarModalDetalle()"></button>
        </div>

        <!-- Body -->
        <div class="modal-body">
          <div *ngIf="recetaSeleccionada">

            <!-- Información General -->
            <div class="card mb-3 border-0 shadow-sm">
              <div class="card-header bg-light fw-semibold">Información General</div>
              <div class="card-body">
                <div class="row g-3">

                  <div class="col-md-4">
                    <label class="text-muted small">Paciente</label>
                    <p class="fw-semibold mb-0">{{ recetaSeleccionada.paciente_nombre }}</p>
                  </div>

                  <div class="col-md-4">
                    <label class="text-muted small">Médico</label>
                    <p class="fw-semibold mb-0">{{ recetaSeleccionada.medico_nombre }}</p>
                  </div>

                  <div class="col-md-4">
                    <label class="text-muted small">Fecha</label>
                    <p class="fw-semibold mb-0">{{ formatearFecha(recetaSeleccionada.fecha_receta) }}</p>
                  </div>

                  <div class="col-12">
                    <label class="text-muted small">Observaciones</label>
                    <p class="mb-0">{{ recetaSeleccionada.observaciones }}</p>
                  </div>

                </div>
              </div>
            </div>

            <!-- Medicamentos -->
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-light fw-semibold">
                <i class="fas fa-pills me-2"></i> Medicamentos Recetados ({{ recetaSeleccionada.detalles.length || 0 }})
              </div>

              <div class="card-body p-0">
                <div class="table-responsive">

                  <table class="table table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Medicamento</th>
                        <th>Dosis</th>
                        <th>Frecuencia</th>
                        <th>Duración</th>
                        <th>Indicaciones</th>
                      </tr>
                    </thead>

                    <tbody>
                      <tr *ngFor="let d of recetaSeleccionada.detalles">
                        <td><strong class="text-primary">{{ d.medicamento }}</strong></td>
                        <td>{{ d.dosis }}</td>
                        <td><span class="badge text-bg-info">{{ d.frecuencia }}</span></td>
                        <td><span class="badge text-bg-success">{{ d.duracion }}</span></td>
                        <td>{{ d.indicaciones }}</td>
                      </tr>
                    </tbody>
                  </table>

                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer bg-light border-top">
          <button class="btn btn-secondary" (click)="cerrarModalDetalle()">
            <i class="fas fa-times me-1"></i> Cerrar
          </button>
          <button class="btn btn-primary" (click)="imprimirReceta()">
            <i class="fas fa-print me-1"></i> Imprimir Receta
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- BACKDROP -->
  <div class="modal-backdrop fade show" *ngIf="mostrarModalDetalle" (click)="cerrarModalDetalle()"></div>

</div>
