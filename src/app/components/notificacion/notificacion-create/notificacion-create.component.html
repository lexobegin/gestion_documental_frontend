<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
          <i class="fas fa-bell me-2"></i>Crear Nueva Notificación
        </h5>
        <a routerLink="/notificacion" class="btn btn-light btn-sm">
          <i class="fas fa-arrow-left me-1"></i> Volver
        </a>
      </div>
    </div>

    <div class="card-body">
      <form #f="ngForm" (ngSubmit)="guardar(f)" novalidate>
        <!-- Información Básica -->
        <div class="row mb-4">
          <div class="col-12">
            <h6 class="text-primary mb-3">
              <i class="fas fa-info-circle me-2"></i>Información Básica
            </h6>
          </div>

          <div class="col-md-6 mb-3">
            <label for="usuario" class="form-label">
              Usuario Destinatario <span class="text-danger">*</span>
            </label>
            <select
              id="usuario"
              class="form-select"
              [(ngModel)]="notificacion.usuario"
              name="usuario"
              required
              [class.is-invalid]="f.submitted && f.controls['usuario'].invalid"
            >
              <option [ngValue]="null">-- Selecciona un usuario --</option>
              <option *ngFor="let user of usuarios" [ngValue]="user.usuario.id">
                {{ user.nombre_completo }} ({{ user.email }}) -
                {{ user.estado }}
              </option>
            </select>
            <div
              class="invalid-feedback"
              *ngIf="f.submitted && f.controls['usuario'].invalid"
            >
              Debe seleccionar un usuario destinatario.
            </div>
            <div class="form-text">Usuario que recibirá la notificación.</div>
          </div>

          <div class="col-md-6 mb-3">
            <label for="tipo" class="form-label">
              Tipo de Notificación <span class="text-danger">*</span>
            </label>
            <select
              id="tipo"
              class="form-select"
              [(ngModel)]="notificacion.tipo"
              name="tipo"
              required
              [class.is-invalid]="f.submitted && f.controls['tipo'].invalid"
            >
              <option
                *ngFor="let tipo of tiposNotificacion"
                [value]="tipo.value"
              >
                {{ tipo.label }}
              </option>
            </select>
            <div
              class="invalid-feedback"
              *ngIf="f.submitted && f.controls['tipo'].invalid"
            >
              Debe seleccionar un tipo de notificación.
            </div>
          </div>

          <div class="col-12 mb-3">
            <label for="titulo" class="form-label">
              Título <span class="text-danger">*</span>
            </label>
            <input
              id="titulo"
              type="text"
              class="form-control"
              [(ngModel)]="notificacion.titulo"
              name="titulo"
              required
              minlength="2"
              maxlength="200"
              placeholder="Ingrese el título de la notificación"
              [class.is-invalid]="f.submitted && f.controls['titulo'].invalid"
            />
            <div
              class="invalid-feedback"
              *ngIf="f.submitted && f.controls['titulo'].invalid"
            >
              El título es requerido y debe tener al menos 2 caracteres.
            </div>
            <div class="form-text">
              Título breve y descriptivo de la notificación.
            </div>
          </div>
        </div>

        <!-- Contenido del Mensaje -->
        <div class="row mb-4">
          <div class="col-12">
            <h6 class="text-primary mb-3">
              <i class="fas fa-envelope me-2"></i>Contenido del Mensaje
            </h6>
          </div>

          <div class="col-12 mb-3">
            <label for="mensaje" class="form-label">
              Mensaje <span class="text-danger">*</span>
            </label>
            <textarea
              id="mensaje"
              class="form-control"
              [(ngModel)]="notificacion.mensaje"
              name="mensaje"
              required
              minlength="5"
              rows="6"
              placeholder="Escriba el mensaje completo de la notificación..."
              [class.is-invalid]="f.submitted && f.controls['mensaje'].invalid"
            ></textarea>
            <div
              class="invalid-feedback"
              *ngIf="f.submitted && f.controls['mensaje'].invalid"
            >
              El mensaje es requerido y debe tener al menos 5 caracteres.
            </div>
            <div class="form-text d-flex justify-content-between">
              <span>Mensaje detallado de la notificación.</span>
              <span
                [class.text-danger]="contadorCaracteres > 500"
                [class.text-muted]="contadorCaracteres <= 500"
              >
                {{ contadorCaracteres }}/500 caracteres
              </span>
            </div>
          </div>
        </div>

        <!-- Configuraciones Adicionales -->
        <div hidden class="row mb-4">
          <div class="col-12">
            <h6 class="text-primary mb-3">
              <i class="fas fa-cog me-2"></i>Configuraciones Adicionales
            </h6>
          </div>

          <div class="col-md-6 mb-3">
            <div class="form-check form-switch">
              <input
                id="leida"
                class="form-check-input"
                type="checkbox"
                [(ngModel)]="notificacion.leida"
                name="leida"
                role="switch"
              />
              <label for="leida" class="form-check-label fw-bold">
                Marcar como leída
              </label>
            </div>
            <div class="form-text">
              Si se activa, la notificación aparecerá como leída inmediatamente.
            </div>
          </div>

          <div class="col-12 mb-3">
            <label for="datos_adicionales" class="form-label">
              Datos Adicionales (JSON)
            </label>
            <textarea
              id="datos_adicionales"
              class="form-control"
              [(ngModel)]="notificacion.datos_adicionales"
              name="datos_adicionales"
              rows="4"
              placeholder='Ejemplo: {"cita_id": 123, "fecha": "2024-01-15", "ubicacion": "Consultorio A"}'
              [class.is-invalid]="!datosAdicionalesValidos"
            ></textarea>
            <div class="invalid-feedback" *ngIf="!datosAdicionalesValidos">
              El formato JSON no es válido. Por favor, verifique la sintaxis.
            </div>
            <div class="form-text">
              Opcional. Datos adicionales en formato JSON para información
              específica de la notificación.
            </div>
          </div>
        </div>

        <!-- Mensajes de Estado -->
        <div
          *ngIf="error"
          class="alert alert-danger alert-dismissible fade show"
          role="alert"
        >
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Error:</strong> {{ error }}
          <button
            type="button"
            class="btn-close"
            (click)="error = undefined"
          ></button>
        </div>

        <div
          *ngIf="mensaje"
          class="alert alert-success alert-dismissible fade show"
          role="alert"
        >
          <i class="fas fa-check-circle me-2"></i>
          <strong>Éxito:</strong> {{ mensaje }}
          <button
            type="button"
            class="btn-close"
            (click)="mensaje = undefined"
          ></button>
        </div>

        <!-- Resumen de la Notificación -->
        <div
          class="card bg-light mb-4"
          *ngIf="notificacion.titulo || notificacion.mensaje"
        >
          <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-eye me-2"></i>Vista Previa</h6>
          </div>
          <div class="card-body">
            <div *ngIf="notificacion.titulo" class="mb-2">
              <strong class="text-primary">{{ notificacion.titulo }}</strong>
            </div>
            <div *ngIf="notificacion.mensaje" class="mb-2">
              <p class="mb-1">{{ notificacion.mensaje }}</p>
            </div>
            <div class="text-muted small">
              <i class="fas fa-info-circle me-1"></i>
              Esta es una vista previa de cómo se verá la notificación.
            </div>
          </div>
        </div>

        <!-- Botones de Acción -->
        <div
          class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top"
        >
          <div>
            <small class="text-muted">
              <i class="fas fa-info-circle me-1"></i>
              Los campos marcados con <span class="text-danger">*</span> son
              obligatorios.
            </small>
          </div>
          <div class="d-flex gap-2">
            <a routerLink="/notificacion" class="btn btn-outline-secondary">
              <i class="fas fa-times me-1"></i> Cancelar
            </a>
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="guardando || !formValid"
            >
              <i class="fas fa-save me-1" *ngIf="!guardando"></i>
              <i class="fas fa-spinner fa-spin me-1" *ngIf="guardando"></i>
              {{ guardando ? "Creando..." : "Crear Notificación" }}
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
